// How to use this script?
// Open a new sheet on docs.google.com and use formula like below
// =GOOGLEFINANCE("NSE:TATAMOTORS", "all", TODAY()-366, TODAY(), "daily")
// Copy an paste the content to the variable data.
// The output will be visible on the console like below,
// Change of 2.93% took 2 days from 29/05/2020 till 01/06/2020 with price change from 87 - 89.55

var data = `Date	Open	High	Low	Close	Volume
07/12/2020 15:30:00	184.45	186.45	182.7	183.55	29802472
08/12/2020 15:30:00	184.95	185.7	178.95	181.8	42143391
09/12/2020 15:30:00	183	186.4	181.65	182.7	40300535
10/12/2020 15:30:00	182.7	182.7	176.4	177.6	38368777
11/12/2020 15:30:00	177.95	181.45	176.5	178.85	43065542
14/12/2020 15:30:00	181	181.5	176.7	177.65	33186273
15/12/2020 15:30:00	176.45	179.7	173.25	178.9	41190341
16/12/2020 15:30:00	181	183.8	180.1	182.55	51259394
17/12/2020 15:30:00	184	184	180.65	181.7	34101954
18/12/2020 15:30:00	180.9	181.5	176.65	180.55	46065197
21/12/2020 15:30:00	176	177.55	162.5	164.55	75582907
22/12/2020 15:30:00	164.55	169.2	156.7	164.95	110009846
23/12/2020 15:30:00	165	169.7	163.4	169.2	56930071
24/12/2020 15:30:00	172	178	172	175.95	73831319
28/12/2020 15:30:00	179.85	187.4	179	186.35	98012135
29/12/2020 15:30:00	187.9	188.45	181.1	183.45	71318085
30/12/2020 15:30:00	183.1	185.4	180.4	184.15	38576159
31/12/2020 15:30:00	184.85	187.5	182.8	183.85	48978310
01/01/2021 15:30:00	184.95	187	184.5	186.5	27334421
04/01/2021 15:30:00	191.8	193	188.75	191.3	63980597
05/01/2021 15:30:00	187.1	193.9	185.05	193.2	75752593
06/01/2021 15:30:00	194.45	197.6	190.65	195.4	75621947
07/01/2021 15:30:00	197	200.35	195.1	196.75	66024848
08/01/2021 15:30:00	198.75	201.5	197.1	198.15	53991568
11/01/2021 15:30:00	199.9	225.4	199.65	220.65	182483100
12/01/2021 15:30:00	227	252.4	224.1	237.8	390577839
13/01/2021 15:30:00	242.9	248.8	238.4	242.6	164649387
14/01/2021 15:30:00	242.85	249.8	238.6	245.1	86819519
15/01/2021 15:30:00	246	264.65	242.6	260.3	250038029
18/01/2021 15:30:00	261.65	262.45	241.15	245.95	173383224
19/01/2021 15:30:00	251.5	261.7	251.3	258.65	136861059
20/01/2021 15:30:00	260	277.5	258.85	274.9	205145151
21/01/2021 15:30:00	281	299	280	290.6	283614463
22/01/2021 15:30:00	295.95	306.9	278.35	289.35	316008609
25/01/2021 15:30:00	296.9	299.5	277.35	279.15	164346913
27/01/2021 15:30:00	274.9	275	265.7	267.5	126586833
28/01/2021 15:30:00	260.05	273.4	259.05	266.8	129156876
29/01/2021 15:30:00	273	278.8	260.6	262.7	138442348
01/02/2021 15:30:00	269.75	282	255.35	279.6	165655500
02/02/2021 15:30:00	293.6	328.85	290.4	322	251965965
03/02/2021 15:30:00	339.2	341.9	326.2	331	224190114
04/02/2021 15:30:00	329	334.5	322.45	326.15	121033002
05/02/2021 15:30:00	327.6	330	312.6	315.9	103512235
08/02/2021 15:30:00	318.75	339.25	318	335.95	102123614
09/02/2021 15:30:00	337	338.5	322.2	325.05	105981081
10/02/2021 15:30:00	326	332.65	319.5	328.9	93466949
11/02/2021 15:30:00	326.45	331.35	323.4	325	55257166
12/02/2021 15:30:00	326.4	330.5	321.25	325.4	64093642
15/02/2021 15:30:00	329.9	335.8	324	333.35	78680452
16/02/2021 15:30:00	335.45	337.9	327.5	329.2	65943843
17/02/2021 15:30:00	326.9	334.25	325.45	330.15	52150941
18/02/2021 15:30:00	331.5	331.75	321.1	323.85	49204247
19/02/2021 15:30:00	321.95	321.95	301.4	311.85	80274683
22/02/2021 15:30:00	312.45	313.9	302.15	304.5	57723298
23/02/2021 15:30:00	308.5	328.9	308.5	324	133310157
24/02/2021 15:30:00	325	330	316.5	321.65	50821757
25/02/2021 15:30:00	325.35	334.7	323.25	333.15	64514912
26/02/2021 15:30:00	323	332.95	318.85	322.95	91901339
01/03/2021 15:30:00	330	331.85	322.7	328.3	61190868
02/03/2021 15:30:00	331.1	347.2	326.45	345.75	127708761
03/03/2021 15:30:00	348.65	357	346.5	348.5	92006451
04/03/2021 15:30:00	339	345.4	337.3	339.2	59863169
05/03/2021 15:30:00	333	337.85	319.7	325.15	86738909
08/03/2021 15:30:00	331.75	331.75	318.8	321.25	81925952
09/03/2021 15:30:00	325	328.35	309.6	315.2	74702208
10/03/2021 15:30:00	319.5	324.45	316.7	321.45	58643853
12/03/2021 15:30:00	325.05	326.5	314.15	317.55	48360842`;

function getAsJSON(data) {
  var lines = data.split("\n");
  var keys = [];
  var rows = [];
  for (var i = 0; i < lines.length; i++) {
    var tokens = lines[i].split("\t");
    if (i === 0) {
      keys = tokens;
      continue;
    }

    var row = {};
    for (let k = 0; k < tokens.length; k++) {
      row[keys[k]] = tokens[k];
    }
    rows.push(row);
  }

  return rows;
}

// How long does it take to reach the percentage of profit given?
function getTimetakenForProfitPercentageFromAnyDay(data, percent) {
  var dataObjs = getAsJSON(data);
  // Loop to start from each day of given set.
  for (let i = 0; i < dataObjs.length; i++) {
    // Inner loop to calculate the percentage from a start day
    // till a specific day till it hits the change expected.
    for (let j = i; j < dataObjs.length; j++) {
      let prevOpen = Number(dataObjs[i].Open);
      let currClose = Number(dataObjs[j].Close);
      let change = ((currClose - prevOpen) / prevOpen) * 100;
      if (change >= percent) {
        // Expected loss between the percentage chagne.
        // Min of open or close price between the
        // percentage change.
        let min = prevOpen;
        for (let m = i; m < j; m++) {
          let currMinOpen = Number(dataObjs[m].Open);
          if (currMinOpen < min) {
            min = currMinOpen;
          }
          let currMinClose = Number(dataObjs[m].Close);
          if (currMinClose < min) {
            min = currMinClose;
          }
        }

        let lossPercentage = ((prevOpen - min) / prevOpen) * 100;

        let days = j - i;
        console.log(
          "Profit of",
          change.toFixed(2) + "%",
          "took",
          days,
          "trading days",
          "from",
          dataObjs[i].Date.split(" ")[0],
          "till",
          dataObjs[j].Date.split(" ")[0],
          "with price change from",
          prevOpen,
          "to",
          currClose,
          "with max unrealized loss of",
          lossPercentage.toFixed(2) + "% -",
          min
        );
        break;
      }
    }
  }
}

getTimetakenForProfitPercentageFromAnyDay(data, 1);
